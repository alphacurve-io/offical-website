name: Deploy API Server

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'api/**'
      - '.github/workflows/deploy-api-server.yml'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.GCP_SSH_PRIVATE_KEY }}

      - name: Add VM to known hosts
        run: |
          ssh-keyscan -H ${{ secrets.GCP_VM_IP }} >> ~/.ssh/known_hosts

      - name: Deploy API Server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.GCP_VM_IP }}
          username: ${{ secrets.GCP_VM_USER }}
          key: ${{ secrets.GCP_SSH_PRIVATE_KEY }}
          script_stop: true
          command_timeout: 30m
          script: |
            # Ë®≠ÂÆöËÆäÊï∏
            # ‰ΩøÁî® GitHub Actions ÂÖßÂª∫ÁöÑ GITHUB_TOKEN
            # Â¶ÇÊûú offical-website ÊòØÁßÅÊúâÂÄâÂ∫´‰∏îÁÑ°Ê≥ïË®™ÂïèÔºåË´ãÂú® Repository secrets ‰∏≠Ê∑ªÂä† GITHUB_TOKEN_PAT
            # ‰∏¶Â∞á‰∏ãÈù¢ÁöÑ ${{ secrets.GITHUB_TOKEN }} ÊîπÁÇ∫ ${{ secrets.GITHUB_TOKEN_PAT }}
            REPO_URL="https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/alphacurve-io/offical-website.git"
            REPO_DIR="$HOME/offical-website"
            
            # Ê∏ÖÁêÜËàäÁöÑ repositoryÔºàÂ¶ÇÊûúÂ≠òÂú®Ôºâ
            if [ -d "$REPO_DIR" ]; then
              rm -rf "$REPO_DIR"
            fi
            
            # Clone repositoryÔºåÂ¢ûÂä†ÈáçË©¶Ê©üÂà∂ÂíåÊõ¥Â•ΩÁöÑÈåØË™§ËôïÁêÜ
            echo "Cloning repository..."
            MAX_RETRIES=3
            RETRY_COUNT=0
            
            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              if git clone "$REPO_URL" "$REPO_DIR" 2>&1; then
                echo "‚úÖ Repository cloned successfully"
                break
              else
                RETRY_COUNT=$((RETRY_COUNT + 1))
                if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                  echo "‚ö†Ô∏è  Clone failed, retrying ($RETRY_COUNT/$MAX_RETRIES)..."
                  sleep 2
                else
                  echo "‚ùå Failed to clone repository after $MAX_RETRIES attempts"
                  echo "Please check:"
                  echo "  1. GITHUB_TOKEN has access to alphacurve-io/offical-website"
                  echo "  2. Repository name is correct"
                  echo "  3. Network connectivity"
                  exit 1
                fi
              fi
            done
            
            # Á≠âÂæÖÂÖ∂‰ªñ dpkg ÈÄ≤Á®ãÂÆåÊàê
            echo "Waiting for any running dpkg processes to complete..."
            MAX_WAIT=300  # ÊúÄÂ§öÁ≠âÂæÖ 5 ÂàÜÈêò
            WAIT_COUNT=0
            while fuser /var/lib/dpkg/lock-frontend /var/lib/dpkg/lock /var/cache/apt/archives/lock >/dev/null 2>&1; do
              if [ $WAIT_COUNT -ge $MAX_WAIT ]; then
                echo "‚ö†Ô∏è  Timeout waiting for dpkg lock. Attempting to continue..."
                break
              fi
              echo "  Waiting for dpkg lock to be released... (${WAIT_COUNT}s)"
              sleep 5
              WAIT_COUNT=$((WAIT_COUNT + 5))
            done
            
            # ÂÖàËôïÁêÜÊêçÂ£ûÁöÑÂåÖÔºåÈÅøÂÖç dpkg --configure ÊôÇÂç°‰Ωè
            # Âº∑Âà∂ÁßªÈô§ËôïÊñº‰∏ç‰∏ÄËá¥ÁãÄÊÖãÁöÑ google-cloud-cli ÂåÖ
            sudo dpkg --remove --force-remove-reinstreq --force-remove-depends google-cloud-cli-anthoscli 2>/dev/null || true
            sudo dpkg --remove --force-remove-reinstreq --force-remove-depends google-cloud-cli 2>/dev/null || true
            
            # ‰øÆÂæ©ÂèØËÉΩË¢´‰∏≠Êñ∑ÁöÑ dpkg ÁãÄÊÖãÔºàË∑≥ÈÅéÁÑ°Ê≥ïÈÖçÁΩÆÁöÑÂåÖÔºâ
            sudo dpkg --configure -a || true
            
            # Ê∏ÖÁêÜ‰∏¶‰øÆÂæ©‰æùË≥¥
            sudo apt-get install -f -y || true
            sudo apt-get autoremove -y || true
            sudo apt-get autoclean || true
            
            # ÂÆâË£ùÂøÖË¶ÅÁöÑÁ≥ªÁµ±Â•ó‰ª∂
            sudo apt-get update -qq
            
            # Ê™¢Êü•ÈúÄË¶ÅÁöÑÂåÖÊòØÂê¶Â∑≤ÂÆâË£ù
            NEEDED_PACKAGES="build-essential pkg-config libssl-dev"
            MISSING_PACKAGES=""
            for pkg in $NEEDED_PACKAGES; do
              if ! dpkg -l | grep -q "^ii  $pkg "; then
                MISSING_PACKAGES="$MISSING_PACKAGES $pkg"
              fi
            done
            
            # Âè™ÂÆâË£ùÁº∫Â§±ÁöÑÂåÖÔºåÂøΩÁï• google-cloud-cli ÁöÑÈåØË™§
            if [ -n "$MISSING_PACKAGES" ]; then
              echo "Installing missing packages: $MISSING_PACKAGES"
              # ‰ΩøÁî® --fix-broken ÂíåÂøΩÁï•ÈåØË™§ÁöÑÊñπÂºèÂÆâË£ù
              DEBIAN_FRONTEND=noninteractive sudo apt-get install -y --fix-broken --allow-remove-essential --allow-change-held-packages $MISSING_PACKAGES 2>&1 | grep -v "google-cloud-cli" || {
                # Âç≥‰ΩøÊúâÈåØË™§Ôºå‰πüÊ™¢Êü•ÂåÖÊòØÂê¶ÁúüÁöÑÂÆâË£ùÊàêÂäü
                for pkg in $MISSING_PACKAGES; do
                  if ! dpkg -l | grep -q "^ii  $pkg "; then
                    echo "‚ö†Ô∏è  Warning: $pkg may not be installed correctly, but continuing..."
                  fi
                done
              }
            else
              echo "‚úÖ All required packages are already installed"
            fi
            
            # È©óË≠âÈóúÈçµÂåÖÊòØÂê¶ÂèØÁî®
            for pkg in build-essential pkg-config libssl-dev; do
              if command -v $(echo $pkg | sed 's/build-essential/gcc/; s/pkg-config/pkg-config/; s/libssl-dev//') >/dev/null 2>&1 || dpkg -l | grep -q "^ii  $pkg "; then
                echo "‚úÖ $pkg is available"
              else
                echo "‚ùå $pkg is missing, but continuing (may cause build issues)"
              fi
            done
            
            # ÂÆâË£ùÊàñÊõ¥Êñ∞ Rust
            if ! command -v rustc &> /dev/null; then
              curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
              source $HOME/.cargo/env
            else
              source $HOME/.cargo/env
              rustup update -y
            fi
            
            # È°ØÁ§∫ Rust ÁâàÊú¨
            rustc --version
            cargo --version
            
            # Á∑®Ë≠Ø Rust Â∞àÊ°à
            cd "$REPO_DIR/api/web_api"
            if [ ! -d "src" ]; then
              echo "‚ùå Error: api/web_api/src directory not found in repository"
              echo "Repository structure may be incorrect"
              exit 1
            fi
            
            # ‰ΩøÁî® cargo Á∑©Â≠òÁõÆÈåÑ‰æÜÂä†ÈÄüÁ∑®Ë≠Ø
            export CARGO_HOME="$HOME/.cargo"
            export CARGO_TARGET_DIR="$HOME/.cargo-target"
            
            # Â¶ÇÊûúÁ∑©Â≠òÂ≠òÂú®ÔºåÈ°ØÁ§∫Á∑©Â≠òÂ§ßÂ∞è
            if [ -d "$CARGO_TARGET_DIR" ]; then
              echo "üì¶ Using cached Cargo target directory"
              du -sh "$CARGO_TARGET_DIR" 2>/dev/null || true
            fi
            
            # Á∑®Ë≠ØÔºà‰ΩøÁî®Á∑©Â≠òÊúÉËá™ÂãïÂä†ÈÄüÔºâ
            echo "üî® Building Rust project (this may take a while on first build)..."
            cargo build --release
            
            # ÂÅúÊ≠¢ËàäÁöÑÊúçÂãôÔºàÂ¶ÇÊûúÊ≠£Âú®ÈÅãË°åÔºâ
            if sudo systemctl is-active --quiet web_api.service; then
              sudo systemctl stop web_api.service
            fi
            
            # ÂÅúÊ≠¢‰ΩîÁî® 8080 Á´ØÂè£ÁöÑÈÄ≤Á®ã
            if lsof -t -i :8080 > /dev/null 2>&1; then
              sudo kill -9 $(sudo lsof -t -i :8080) || true
            fi
            
            # Ë§áË£Ω‰∫åÈÄ≤Âà∂Êñá‰ª∂Âà∞Á≥ªÁµ±ÁõÆÈåÑ
            # ‰ΩøÁî® CARGO_TARGET_DIR ‰æÜÊâæÂà∞Ê≠£Á¢∫ÁöÑÊßãÂª∫Ë∑ØÂæë
            if [ -f "$CARGO_TARGET_DIR/release/web_api" ]; then
              sudo cp "$CARGO_TARGET_DIR/release/web_api" /usr/local/bin/web_api
            elif [ -f "./target/release/web_api" ]; then
              sudo cp ./target/release/web_api /usr/local/bin/web_api
            else
              echo "‚ùå Error: web_api binary not found in expected locations"
              echo "Checked: $CARGO_TARGET_DIR/release/web_api and ./target/release/web_api"
              exit 1
            fi
            sudo chmod +x /usr/local/bin/web_api
            
            # Ë§áË£Ω RAG ‰∏ä‰∏ãÊñáÊñá‰ª∂Âà∞Á≥ªÁµ±ÁõÆÈåÑ
            if [ -f "$REPO_DIR/api/web_api/rag_context.txt" ]; then
              sudo cp "$REPO_DIR/api/web_api/rag_context.txt" /usr/local/bin/rag_context.txt
              echo "‚úÖ RAG context file copied"
            else
              echo "‚ö†Ô∏è Warning: rag_context.txt not found, using default context"
            fi
            
            # Á¢∫‰øù .env Êñá‰ª∂Â≠òÂú®ÔºàÂ¶ÇÊûúÈúÄË¶ÅÁöÑË©±Ôºâ
            if [ ! -f /usr/local/bin/.env ]; then
              echo "Warning: /usr/local/bin/.env not found. Service may need environment variables."
            fi
            
            # Êõ¥Êñ∞ systemd ÊúçÂãôÊñá‰ª∂
            sudo tee /etc/systemd/system/web_api.service > /dev/null <<EOF
            [Unit]
            Description=AlphaCurve Web API Service
            After=network.target
            
            [Service]
            User=${{ secrets.GCP_VM_USER }}
            Group=${{ secrets.GCP_VM_USER }}
            ExecStart=/usr/local/bin/web_api
            EnvironmentFile=/usr/local/bin/.env
            Environment="OLLAMA_BASE_URL=${{ secrets.OLLAMA_BASE_URL }}"
            Environment="OLLAMA_API_KEY=${{ secrets.OLLAMA_API_KEY }}"
            Environment="OLLAMA_MODEL=gpt-oss:120b"
            Environment="ALLOWED_DOMAINS=${{ secrets.ALLOWED_DOMAINS }}"
            Restart=always
            RestartSec=5
            
            [Install]
            WantedBy=multi-user.target
            EOF
            
            # ÈáçÊñ∞ËºâÂÖ• systemd ‰∏¶ÂïüÂãïÊúçÂãô
            sudo systemctl daemon-reload
            sudo systemctl enable web_api.service
            sudo systemctl restart web_api.service
            
            # Á≠âÂæÖÊúçÂãôÂïüÂãï
            sleep 3
            
            # Ê™¢Êü•ÊúçÂãôÁãÄÊÖã
            sudo systemctl status web_api.service --no-pager
            
            # È©óË≠âÊúçÂãôÊòØÂê¶Ê≠£Â∏∏ÈÅãË°å
            if sudo systemctl is-active --quiet web_api.service; then
              echo "‚úÖ Service is active"
              
              # Á≠âÂæÖÊúçÂãôÂÆåÂÖ®ÂïüÂãï
              sleep 2
              
              # ÂÅ•Â∫∑Ê™¢Êü• - Ê∏¨Ë©¶ /health endpoint
              if curl -f -s http://localhost:8080/health > /dev/null; then
                echo "‚úÖ Health check passed!"
                curl -s http://localhost:8080/health | jq . || curl -s http://localhost:8080/health
              else
                echo "‚ö†Ô∏è  Health check failed, but service is running"
                curl -v http://localhost:8080/health || true
              fi
              
              echo "‚úÖ API Server deployed successfully!"
            else
              echo "‚ùå API Server failed to start"
              sudo journalctl -u web_api.service -n 50 --no-pager
              exit 1
            fi

      - name: Send Telegram Notification
        if: always()
        uses: appleboy/telegram-action@v1.0.0
        with:
          to: ${{ secrets.TELEGRAM_TO }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: |
            üöÄ API Server Deployment
            Status: ${{ job.status }}
            Branch: ${{ github.ref_name }}
            Commit: ${{ github.sha }}
            Author: ${{ github.actor }}
            ${{ job.status == 'success' && '‚úÖ Deployment successful!' || '‚ùå Deployment failed!' }}

