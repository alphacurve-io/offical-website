name: Deploy to GCP VM

on:
  push:
    tags:
      - '*'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18' # Adjust version as needed, defaulting to 18
        cache: 'npm' # ÂêØÁî® npm ÁºìÂ≠ò‰ª•Âä†Âø´ÊûÑÂª∫ÈÄüÂ∫¶

    - name: Install dependencies
      run: npm ci --prefer-offline --no-audit

    - name: Build with optimization
      run: npm run build
      env:
        NODE_ENV: production
        GENERATE_SOURCEMAP: false # Á¶ÅÁî® source map ‰ª•ÂáèÂ∞èÊñá‰ª∂Â§ßÂ∞è

    - name: Analyze build size
      run: |
        echo "üì¶ Build size analysis:"
        du -sh build/
        echo ""
        echo "üìä Largest files:"
        find build -type f -exec du -h {} + | sort -rh | head -10
        echo ""
        echo "üìà JS files:"
        find build/static/js -type f -name "*.js" -exec du -h {} + | sort -rh | head -5
        echo ""
        echo "üé® CSS files:"
        find build/static/css -type f -name "*.css" -exec du -h {} + | sort -rh | head -5
        echo ""
        echo "‚úÖ Compression verification:"
        # Ê£ÄÊü• JS Êñá‰ª∂ÊòØÂê¶Ë¢´ÂéãÁº©ÔºàÂéãÁº©ÂêéÁöÑÊñá‰ª∂ÈÄöÂ∏∏‰∏çÂåÖÂê´Ê≥®ÈáäÂíåÁ©∫Ê†ºÔºâ
        JS_FILE=$(find build/static/js -name "*.js" | head -1)
        if [ -f "$JS_FILE" ]; then
          if grep -q "console.log\|console.debug" "$JS_FILE" 2>/dev/null; then
            echo "‚ö†Ô∏è  Warning: console.log found in JS (compression may not be working)"
          else
            echo "‚úÖ JS files are properly minified (no console.log found)"
          fi
        fi
        # Ê£ÄÊü• CSS Êñá‰ª∂ÊòØÂê¶Ë¢´ÂéãÁº©
        CSS_FILE=$(find build/static/css -name "*.css" | head -1)
        if [ -f "$CSS_FILE" ]; then
          if grep -q "/\*" "$CSS_FILE" 2>/dev/null; then
            echo "‚ö†Ô∏è  Warning: Comments found in CSS (compression may not be working)"
          else
            echo "‚úÖ CSS files are properly minified (no comments found)"
          fi
        fi

    - name: Zip build folder
      run: zip -r build.zip build

    - name: Copy files to VM
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.GCP_VM_IP }}
        username: ${{ secrets.GCP_VM_USER }}
        key: ${{ secrets.GCP_SSH_PRIVATE_KEY }}
        source: "build.zip"
        target: "~/"

    - name: Deploy on VM
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.GCP_VM_IP }}
        username: ${{ secrets.GCP_VM_USER }}
        key: ${{ secrets.GCP_SSH_PRIVATE_KEY }}
        script: |
          # Remove old build.zip if exists (though scp overwrites, good to be clean)
          # Unzip new build
          unzip -o ~/build.zip -d ~/
          
          # Remove zip after unzip
          rm ~/build.zip
          
          # Clean old html files
          # Using sudo if necessary, but script used user permissions for /var/www/alphacurve.io/html
          # Assuming user has permissions as per original script
          rm -rf /var/www/alphacurve.io/html/*
          
          # Move new build files
          mv ~/build/* /var/www/alphacurve.io/html/
          
          # Cleanup extracted build folder
          rm -rf ~/build

    - name: Send Telegram Notification on Success
      if: success()
      uses: appleboy/telegram-action@master
      with:
        to: ${{ secrets.TELEGRAM_TO }}
        token: ${{ secrets.TELEGRAM_TOKEN }}
        message: |
          ‚úÖ Deployment Successful!
          Repository: ${{ github.repository }}
          Tag: ${{ github.ref_name }}

    - name: Send Telegram Notification on Failure
      if: failure()
      uses: appleboy/telegram-action@master
      with:
        to: ${{ secrets.TELEGRAM_TO }}
        token: ${{ secrets.TELEGRAM_TOKEN }}
        message: |
          ‚ùå Deployment Failed!
          Repository: ${{ github.repository }}
          Tag: ${{ github.ref_name }}
